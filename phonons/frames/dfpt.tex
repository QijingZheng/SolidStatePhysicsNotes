\begin{frame}[allowframebreaks]
  \frametitle{Density Functional Perturbation Theory}

  % \begin{center}
  %   \resizebox{!}{0.4\textheight}{
  %   \begin{tikzpicture}
  %     [
  %     % spring/.style={
  %     %   line width=0.5pt,
  %     %   decorate,
  %     %   decoration={
  %     %       coil,
  %     %       amplitude=1.5,
  %     %       segment length=3.5,
  %     %     }
  %     %   },
  %     ]

  %     \path[
  %       decorate,
  %       decoration={
  %         text along path, 
  %         text={$\left[-{\hbar^2\over2m}\nabla^2 +
  %             V_{KS}(\boldr)\right]\psi_n(\boldr) =
  %           \varepsilon_n \psi(\boldr)$}
  %       }
  %     ]
  %     arc [
  %     radius=3, start angle=0, end angle = 120
  %     ];
  %     % \foreach \i in {0,..., 11}{
  %     %   \draw[spring, draw=red] (\i*30:2) arc [
  %     %     radius=2, start angle=\i * 30, end angle=\i * 30 + 30
  %     %   ];
  %     %   \shade[ball color=blue] (\i*30:2) circle (0.15);
  %     %   \ifthenelse{\i < 5}{
  %     %     \node[] at (\i * 30 : 1.7) {\small\textsf{\i}};
  %     %     \node[] at (\i * 30 : 2.5) {\small\textsf{N + \i}};
  %     %   }{}
  %     % }
  %     % \node[] at (8 * 30 : 1.7) {\small\textsf{n}};
  %     % \node[] at (8 * 30 : 2.5) {\small\textsf{N + n}};
  %   \end{tikzpicture}
  %   }
  % \end{center}
  \begin{multicols}{2}
    \textcolor{blue}{The Kohn-Sham eqution}
    \begin{align*}
      \biggl[
        -{\hbar^2\over2m}\nabla^2 &+ V_{KS}(\boldr; \mu)
      \biggr]
      \psi_n(\boldr)
      =
      \varepsilon_n
      \psi_n(\boldr) \\
      \rho(\boldr)
      & =
      \sum_n^{occ} |\psi_n(\boldr)|^2 \\
      V_{KS}(\boldr)
      & =
      V_{ext}(\boldr) +
      V_{H}(\boldr) +
      V_{xc}(\boldr)
    \end{align*}

    With a small perturbation $\mu$
    \begin{align*}
      V_{KS}(\boldr; \mu)
      & =
      V_{KS}(\boldr; \mu=0) +
      \mu \frac{
        \partial V_{KS}(\boldr)
      }{
        \partial \mu
      } \\
      \psi_n(\boldr; \mu)
      & =
      \psi_n(\boldr; \mu=0) +
      \mu \frac{
        \partial \psi_n(\boldr)
      }{
        \partial \mu
      } \\
      \varepsilon_n(\mu)
      & =
      \varepsilon_n(\mu=0) +
      \mu \frac{
        \partial \varepsilon_n
      }{
        \partial \mu
      }
    \end{align*}
  \end{multicols}
  
  \begin{center}
    \tikz \draw[baseline=current bounding box.center, line width=0.5pt] (0, 0) -- (3in, 0);
  \end{center}

  Inserting these equations and keeps only the first-order terms
  \begin{equation}
    \label{eq:dfpt_eq}
    \biggl[
    -{\hbar^2\over2m}\nabla^2 + V_{KS}(\boldr) - \varepsilon_n
    \biggr]
    \frac{
      \partial \psi_n(\boldr)
    }{
      \partial\mu
    }
    =
    -
    \left[
        \frac{
        \partial V_{KS}(\boldr)
        }{
        \partial\mu
        }
        -
        \frac{
        \partial \varepsilon_n
        }{
        \partial\mu
        }
    \right]
      \psi_n(\boldr)
  \end{equation}

  where
  \begin{align}
    \frac{
      \partial V_{KS}(\boldr)
    }{
      \partial \mu
    }
    =
    \frac{
      \partial V_{ext}(\boldr)
    }{
      \partial \mu
    }
    &+
    \frac{
      \partial V_{H}(\boldr)
    }{
      \partial \mu
    }
    +
    \frac{
      \partial V_{xc}(\boldr)
    }{
      \partial \mu
    } \\[3pt]
    \frac{
      \partial V_{H}(\boldr)
    }{
      \partial \mu
    }
    =
    \int \frac{
      1
    }{
      |\boldr - \boldr'|
    }
    \mathcolor{red}{
      \frac{
      \partial \rho(\boldr')
      }{
      \partial \mu
    }} \, \mathrm{d}\boldr';
    &\qquad
    \frac{
      \partial V_{xc}(\boldr)
    }{
      \partial \mu
    }
    =
    \frac{
      \mathrm{d} V_{xc}
    }{
      \mathrm{d} \rho(\boldr)
    }
    \mathcolor{red}{
      \frac{
      \partial \rho(\boldr)
      }{
      \partial \mu
    }}
    % \frac{
    %   \partial \rho(\boldr)
    % }{
    %   \partial \mu
    % }
    % &=
    % \sum_n^{occ}
    % \left[
    %     \frac{
    %     \partial \psi^*_n(\boldr)
    %     }{
    %     \partial \mu
    %     }
    %     \psi_n(\boldr)
    %     +
    %     \psi^*_n(\boldr)
    %     \frac{
    %     \partial \psi_n(\boldr)
    %     }{
    %     \partial \mu
    %     }
    % \right]
  \end{align}

  \break

  \textcolor{blue}{Electron density response to the perturbation}
  \small

  \begin{align}
    \frac{
      \partial \rho(\boldr)
    }{
      \partial \mu
    }
    &=
    \sum_n^{occ}
    \left[
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
        \psi_n(\boldr)
        +
        \psi_n^*(\boldr)
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
    \right] \label{eq:density_response_all}\\
    \frac{
      \partial \psi_n(\boldr)
    }{
      \partial \mu
    }
    &=
    \sum_{m\ne n}
    \frac{
      \braket{
        \psi_m |
        {\partial V_{KS}(\boldr)\over \partial \mu}
        | \psi_n
      }
    }{
        \varepsilon_n - \varepsilon_m
    }
    \psi_m(\boldr) \label{eq:wfc_response}
  \end{align}
  Where $n$ is the index for the occupied staets and $m$ runs over all the states.
  % Substitute Eq.~\ref{eq:wfc_response} into Eq.~\ref{eq:density_response_all},
  % it can be shown that the 

  \medskip

  Define $P_v = \sum_n^{occ} \ket{\psi_n}\bra{\psi_n}$ as the projector on the valence
  bands, then $P_c = \mathbb{1} - P_v$ is the projector on the conduction bands
  \begin{align*}
    \frac{
      \partial \rho(\boldr)
    }{
      \partial \mu
    }
    &=
    \sum_n^{occ}
    \left[
      P_c
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
        \psi_n(\boldr)
        +
        \psi_n^*(\boldr)
        P_c
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
    \right]
    +
    \sum_n^{occ}
    \left[
      P_v
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
        \psi_n(\boldr)
        +
        \psi_n^*(\boldr)
        P_v
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
    \right] \\
    &=
    \sum_n^{occ}
    \left[
      P_c
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
        \psi_n(\boldr)
        +
        \psi_n^*(\boldr)
        P_c
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
    \right]
    +
    \sum_{mn}^{occ}
      \psi^*_m(\boldr)
      \psi_n(\boldr)
      \left(
      \braket{
        \frac{
        \partial \psi_n
        }{
        \partial \mu
        }
        |
        \psi_m
      }
      +
      \braket{
        \psi_n
        |
        \frac{
        \partial \psi_m
        }{
        \partial \mu
        }
      }
      \right)
  \end{align*}

  Due the orthonormality of $\psi_n(\boldr)$, i.e.\ $\braket{\psi_m | \psi_n} = \delta_{mn}$

  \begin{equation}
    \label{eq:density_response}
    \frac{
      \partial \rho(\boldr)
    }{
      \partial \mu
    }
    =
    \sum_n^{occ}
    \left[
      P_c
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
        \psi_n(\boldr)
        +
        \psi_n^*(\boldr)
        P_c
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
    \right]
  \end{equation}

  The electron density response depends only on the component of the
  perturbation that \emph{ couples the occupied states with the empty ones.}

  \break

  Apply $P_c$ on the left and right-hand side of Eq.~\ref{eq:dfpt_eq}
  \begin{equation}
    \label{eq:dfpt_eq_final}
    \biggl[
    -{\hbar^2\over2m}\nabla^2 + V_{KS}(\boldr)
    +
    \mathcolor{olive}{
      \alpha P_v
    }
    - \varepsilon_n
    \biggr]
    \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial\mu
        }
    }
    =
    -(\mathbb{1} - P_v)
    \mathcolor{blue}{
    \frac{
      \partial V_{KS}(\boldr)
    }{
      \partial\mu
    }
    }
    \psi_n(\boldr)
  \end{equation}

  where the $\mathcolor{olive}{\alpha P_v}$ is added to make the left-hand-side nonsingular.

  \begin{align}
    \mathcolor{blue}{
    \frac{
      \partial V_{KS}(\boldr)
    }{
      \partial \mu
    }}
    &=
    \frac{
      \partial V_{ext}(\boldr)
    }{
      \partial \mu
    }
    +
    \int \frac{
      1
    }{
      |\boldr - \boldr'|
    }
    \mathcolor{red}{
      \frac{
      \partial \rho(\boldr')
      }{
      \partial \mu
    }} \, \mathrm{d}\boldr'
    +
    \frac{
      \mathrm{d} V_{xc}
    }{
      \mathrm{d} \rho(\boldr)
    }
    \mathcolor{red}{
      \frac{
      \partial \rho(\boldr)
      }{
      \partial \mu
    }} \label{eq:perturbation_final}
    \\[6pt]
    \mathcolor{red}{
        \frac{
        \partial \rho(\boldr)
        }{
        \partial \mu
        }
    }
    &=
    \sum_n^{occ}
    \left[
      \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_n^*(\boldr)
        }{
        \partial \mu
        }
      }
      \psi_n(\boldr)
      +
      \psi_n^*(\boldr)
      \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_n(\boldr)
        }{
        \partial \mu
        }
      }
    \right]
    \nonumber
  \end{align}


  Considering the time-reversal symmetry $\psi^*_{n,\text{-}\bdm{k}}(\boldr) =
  \psi_{n,\bdm{k}}(\boldr)$

  \begin{align}
    \mathcolor{red}{
        \frac{
        \partial \rho(\boldr)
        }{
        \partial \mu
        }
    }
    &=
    \sum_{n,\text{-}\bdm{k}}^{occ}
      \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_{n,\text{-}\bdm{k}}^*(\boldr)
        }{
        \partial \mu
        }
      }
      \psi_{n,\text{-}\bdm{k}}(\boldr)
      +
    \sum_{n,\bdm{k}}^{occ}
      \psi_{n,\bdm{k}}^*(\boldr)
      \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_{n,\bdm{k}}(\boldr)
        }{
        \partial \mu
        }
      } \nonumber \\[6pt]
    &=
    2\sum_{n,\bdm{k}}^{occ}
      \psi_{n,\bdm{k}}^*(\boldr)
      \mathcolor{green}{
        P_c
        \frac{
        \partial \psi_{n,\bdm{k}}(\boldr)
        }{
        \partial \mu
        }
      } \label{eq:density_response_final}
  \end{align}
  Eq.~\ref{eq:dfpt_eq_final}, Eq.~\ref{eq:perturbation_final} and
  Eq.~\ref{eq:density_response_final} form a set of self-consistent euqations
  for the perturbed system.


\end{frame}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
